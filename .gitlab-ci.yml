include:
  - project: 'dev_tls/giza/templates'
    ref: $CICD_TEMPLATE_VERSION
    file:
      - 'rollback.gitlab-ci.yml'
      - 'quality_security-check.gitlab-ci.yml'

image: ${DOCKER_REGISTRY_ADDRESS}/openshift3/ose-cli:${DOCKER_TAG_OSE_CLI}

default:
  tags:
    - tlsdev-aws

variables:
  APPLICATION_NAME: "payment-api"
  ENV: "IET2"
  APP_ENV: "test"
  PROJECT: "visa-be-dev"
  CLIENT: "schengen-be"
  DATABASE: $DATABASE
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  DIRECTUS_ROUTE: "directus"
  TLSCONNECT_API_URL: "https://tlsconnect-service-api.${PROJECT}.svc:8443"
  EMAIL_SERVICE_DOMAIN: "https://tlsconnect-email-service.${PROJECT}.svc:8443"
  ENABLE_DAST: "true"

stages:
  - build
  - test
  - deploy
  - post
  - rollback

prepare-instance:
  stage: build
  image: ${DOCKER_REGISTRY_ADDRESS}/tlscontact/composer:${DOCKER_TAG_COMPOSER}
  script:
    - composer install -o
  after_script:
    - rm -rf composer.*
  artifacts:
    paths:
      - ./
    expire_in: 1 hour
  environment:
    name: $ENV
  rules:
    - if: $ROLLBACK == "true" || $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - when: on_success

test-unit:
  stage: test
  image: ${DOCKER_REGISTRY_ADDRESS}/tlscontact/composer:${DOCKER_TAG_COMPOSER}
  dependencies:
    - prepare-instance
  before_script:
    - apk add g++ make zlib-dev autoconf file gcc libc-dev make g++ pkgconf re2c
    - pecl install xdebug && docker-php-ext-enable xdebug
    - docker-php-ext-install bcmath
    - apk add postgresql postgresql-dev
    - docker-php-ext-install pdo pgsql pdo_pgsql
    - addgroup -S postgres && adduser -S postgres -G postgres
    - mkdir -p /var/lib/postgresql/data
    - mkdir -p /run/postgresql/
    - chown -R postgres:postgres /run/postgresql/
    - chmod -R 777 /var/lib/postgresql/data
    - chown -R postgres:postgres /var/lib/postgresql/data
    - su postgres -c "initdb /var/lib/postgresql/data; echo 'host all  all    0.0.0.0/0  md5' >> /var/lib/postgresql/data/pg_hba.conf; pg_ctl start -D /var/lib/postgresql/data -l /var/lib/postgresql/log.log;"
    - psql -U postgres -c "CREATE ROLE root WITH SUPERUSER; CREATE ROLE common WITH SUPERUSER; ALTER ROLE root WITH LOGIN; ALTER ROLE root WITH CREATEDB;"
  script:
    - export XDEBUG_MODE="coverage"
    - ./vendor/bin/phpunit --coverage-clover=coverage-report.clover --log-junit unittest-report.xml
  artifacts:
    when: always
    reports:
      junit:
        - unittest-report.xml
    paths:
      - "./"
    expire_in: 3 days
  rules:
    - if: $ROLLBACK == "true" || $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - when: on_success
      allow_failure: true

deploy-instance:
  stage: deploy
  dependencies: []
  variables:
    MEMORY_REQUEST: "256Mi"
    MEMORY_LIMIT: "512Mi"
    CPU_REQUEST: "10m"
    INSTANCE: $PROJECT
  before_script:
    - echo "${MASTER_PUBLIC_URL}"
    - oc login --token=${GITLAB_SA_TOKEN} --insecure-skip-tls-verify=true ${MASTER_PUBLIC_URL}
  script:
    - oc project ${PROJECT} 2> /dev/null || oc new-project ${PROJECT}
    - |
      if ! PAYMENT_SERVICE_URL=$(oc get route payment -o jsonpath='{.spec.host}'); then
        echo "PAYMENT_SERVICE_URL is not defined!"
        exit 1
      fi
    - |
      if ! DIRECTUS_HOST=$(oc get route ${DIRECTUS_ROUTE} -o jsonpath='{.spec.host}'); then
        echo "DIRECTUS_HOST is not defined!"
        exit 1
      fi
    - |
      if REDIS_HOST=$(oc get svc ${PROJECT}-redis-cluster-aws -o json); then
        export REDIS_HOST=$(echo "${REDIS_HOST}" | jq -r .spec.externalName)
      else
        echo "REDIS_HOST is not defined!"
        exit 1
      fi
    - oc process -f ./openshift/payment-api-template.yaml
      APPLICATION_NAME="${APPLICATION_NAME}"
      PROJECT="${INSTANCE}"
      NAMESPACE="${PROJECT}"
      APP_ENV="${APP_ENV}"
      OPENSHIFT_ENV="${ENV}"
      ROUTE_IP_WHITE_LIST="${ROUTE_IP_WHITE_LIST}"
      POSTGRES_DB_HOST="pgbouncer"
      POSTGRES_SECRET_NAME="${PROJECT}-pgcluster-common-secret"
      POSTGRES_ADMIN_SECRET_NAME="${PROJECT}-pgsql-master"
      POSTGRES_PAYMENT_DB_DATABASE="payment-${DATABASE}"
      AWS_ACCOUNT_S3="tlspay-s3-account"
      PAYMENT_SERVICE_DOMAIN="https://${PAYMENT_SERVICE_URL}"
      DIRECTUS_DOMAIN="https://${DIRECTUS_HOST}"
      TLSCONTACT_API="${TLSCONNECT_API_URL}"
      REDIS_HOST="tls://${REDIS_HOST}"
      CLIENT="${CLIENT}"
      KBANK_THBKK2BE_SANDBOX_API_KEY="${KBANK_THBKK2BE_SANDBOX_API_KEY}"
      KBANK_THBKK2BE_SANDBOX_SECRET="${KBANK_THBKK2BE_SANDBOX_SECRET}"
      KBANK_THBKK2BE_SANDBOX_MID="${KBANK_THBKK2BE_SANDBOX_MID}"
      KBANK_THBKK2BE_API_KEY="${KBANK_THBKK2BE_API_KEY}"
      KBANK_THBKK2BE_SECRET="${KBANK_THBKK2BE_SECRET}"
      KBANK_THBKK2BE_MID="${KBANK_THBKK2BE_MID}"
      ENVPAY_CMI_BEmaAll2be_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_BEmaAll2be_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_BEmaAll2be_SANDBOX_STOREKEY="${ENVPAY_CMI_BEmaAll2be_SANDBOX_STOREKEY}"
      ENVPAY_CMI_BEmaAll2be_MERCHANT_ID="${ENVPAY_CMI_BEmaAll2be_MERCHANT_ID}"
      ENVPAY_CMI_BEmaAll2be_STOREKEY="${ENVPAY_CMI_BEmaAll2be_STOREKEY}"
      ENVPAY_CMI_DEmaAll2de_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_DEmaAll2de_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_DEmaAll2de_SANDBOX_STOREKEY="${ENVPAY_CMI_DEmaAll2de_SANDBOX_STOREKEY}"
      ENVPAY_CMI_DEmaAll2de_MERCHANT_ID="${ENVPAY_CMI_DEmaAll2de_MERCHANT_ID}"
      ENVPAY_CMI_DEmaAll2de_STOREKEY="${ENVPAY_CMI_DEmaAll2de_STOREKEY}"
      ENVPAY_YOOKASSA_COMMON_SANDBOX_SHOP_ID="${ENVPAY_YOOKASSA_COMMON_SANDBOX_SHOP_ID}"
      ENVPAY_YOOKASSA_COMMON_SANDBOX_SECRET="${ENVPAY_YOOKASSA_COMMON_SANDBOX_SECRET}"
      ENVPAY_YOOKASSA_COMMON_SHOP_ID="${ENVPAY_YOOKASSA_COMMON_SHOP_ID}"
      ENVPAY_YOOKASSA_COMMON_SECRET="${ENVPAY_YOOKASSA_COMMON_SECRET}"
      ENVPAY_TINGG_COMMON_SANDBOX_ACCOUNT_NUMBER="${ENVPAY_TINGG_COMMON_SANDBOX_ACCOUNT_NUMBER}"
      ENVPAY_TINGG_COMMON_SANDBOX_SERVICE_CODE="${ENVPAY_TINGG_COMMON_SANDBOX_SERVICE_CODE}"
      ENVPAY_TINGG_COMMON_SANDBOX_IVKEY="${ENVPAY_TINGG_COMMON_SANDBOX_IVKEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_SECRET_KEY="${ENVPAY_TINGG_COMMON_SANDBOX_SECRET_KEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_ACCESS_KEY="${ENVPAY_TINGG_COMMON_SANDBOX_ACCESS_KEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_ID="${ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_ID}"
      ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_SECRET="${ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_SECRET}"
      ENVPAY_TINGG_COMMON_SANDBOX_OAUTH_HOST="${ENVPAY_TINGG_COMMON_SANDBOX_OAUTH_HOST}"
      ENVPAY_TINGG_COMMON_SANDBOX_QUERY_STATUS_HOST="${ENVPAY_TINGG_COMMON_SANDBOX_QUERY_STATUS_HOST}"
      ENVPAY_TINGG_COMMON_ACCOUNT_NUMBER="${ENVPAY_TINGG_COMMON_ACCOUNT_NUMBER}"
      ENVPAY_TINGG_COMMON_SERVICE_CODE="${ENVPAY_TINGG_COMMON_SERVICE_CODE}"
      ENVPAY_TINGG_COMMON_IVKEY="${ENVPAY_TINGG_COMMON_IVKEY}"
      ENVPAY_TINGG_COMMON_SECRET_KEY="${ENVPAY_TINGG_COMMON_SECRET_KEY}"
      ENVPAY_TINGG_COMMON_ACCESS_KEY="${ENVPAY_TINGG_COMMON_ACCESS_KEY}"
      ENVPAY_TINGG_COMMON_CLIENT_ID="${ENVPAY_TINGG_COMMON_CLIENT_ID}"
      ENVPAY_TINGG_COMMON_CLIENT_SECRET="${ENVPAY_TINGG_COMMON_CLIENT_SECRET}"
      ENVPAY_TINGG_COMMON_OAUTH_HOST="${ENVPAY_TINGG_COMMON_OAUTH_HOST}"
      ENVPAY_TINGG_COMMON_QUERY_STATUS_HOST="${ENVPAY_TINGG_COMMON_QUERY_STATUS_HOST}"
      ENVPAY_TINGG_DEtzDAR2de_ACCOUNT_NUMBER="${ENVPAY_TINGG_DEtzDAR2de_ACCOUNT_NUMBER}"
      ENVPAY_TINGG_DEtzDAR2de_SERVICE_CODE="${ENVPAY_TINGG_DEtzDAR2de_SERVICE_CODE}"
      ENVPAY_TINGG_DEtzDAR2de_IVKEY="${ENVPAY_TINGG_DEtzDAR2de_IVKEY}"
      ENVPAY_TINGG_DEtzDAR2de_SECRET_KEY="${ENVPAY_TINGG_DEtzDAR2de_SECRET_KEY}"
      ENVPAY_TINGG_DEtzDAR2de_ACCESS_KEY="${ENVPAY_TINGG_DEtzDAR2de_ACCESS_KEY}"
      ENVPAY_TINGG_DEtzDAR2de_CLIENT_ID="${ENVPAY_TINGG_DEtzDAR2de_CLIENT_ID}"
      ENVPAY_TINGG_DEtzDAR2de_CLIENT_SECRET="${ENVPAY_TINGG_DEtzDAR2de_CLIENT_SECRET}"
      ENVPAY_TINGG_DEtzDAR2de_OAUTH_HOST="${ENVPAY_TINGG_DEtzDAR2de_OAUTH_HOST}"
      ENVPAY_TINGG_DEtzDAR2de_QUERY_STATUS_HOST="${ENVPAY_TINGG_DEtzDAR2de_QUERY_STATUS_HOST}"
      PAYGATE_ZAALL2BE_ENCRYPTION_SANDBOX_KEY="${PAYGATE_ZAALL2BE_ENCRYPTION_SANDBOX_KEY}"
      PAYGATE_ZAALL2BE_SANDBOX_ID="${PAYGATE_ZAALL2BE_SANDBOX_ID}"
      PAYGATE_ZAALL2BE_ENCRYPTION_KEY="${PAYGATE_ZAALL2BE_ENCRYPTION_KEY}"
      PAYGATE_ZAALL2BE_ID="${PAYGATE_ZAALL2BE_ID}"
      PAYGATE_ZAALL2BE_SELLER_EMAIL="${PAYGATE_ZAALL2BE_SELLER_EMAIL}"
      FAW_COMMON_SANDBOX_MERCHANT_ID="${FAW_COMMON_SANDBOX_MERCHANT_ID}"
      FAW_COMMON_SANDBOX_SECRET_KEY="${FAW_COMMON_SANDBOX_SECRET_KEY}"
      FAW_DEegAll2de_SANDBOX_MERCHANT_ID="${FAW_DEegAll2de_SANDBOX_MERCHANT_ID}"
      FAW_DEegAll2de_SANDBOX_SECRET_KEY="${FAW_DEegAll2de_SANDBOX_SECRET_KEY}"
      FAW_DEegCAI2de_MERCHANT_ID="${FAW_DEegCAI2de_MERCHANT_ID}"
      FAW_DEegCAI2de_SECRET_KEY="${FAW_DEegCAI2de_SECRET_KEY}"
      FAW_DEegALY2de_MERCHANT_ID="${FAW_DEegALY2de_MERCHANT_ID}"
      FAW_DEegALY2de_SECRET_KEY="${FAW_DEegALY2de_SECRET_KEY}"
      FAW_DEegHRG2de_MERCHANT_ID="${FAW_DEegHRG2de_MERCHANT_ID}"
      FAW_DEegHRG2de_SECRET_KEY="${FAW_DEegHRG2de_SECRET_KEY}"
      FAW_FRegAll2fr_SANDBOX_MERCHANT_ID="${FAW_FRegAll2fr_SANDBOX_MERCHANT_ID}"
      FAW_FRegAll2fr_SANDBOX_SECRET_KEY="${FAW_FRegAll2fr_SANDBOX_SECRET_KEY}"
      FAW_egAll2be_MERCHANT_ID="${FAW_egAll2be_MERCHANT_ID}"
      FAW_egAll2be_SECURITY_KEY="${FAW_egAll2be_SECURITY_KEY}"
      ENVPAY_GLO_COMMON_SANDBOX_MERCHANT_ID="${ENVPAY_GLO_COMMON_SANDBOX_MERCHANT_ID}"
      ENVPAY_GLO_COMMON_SANDBOX_SECRET="${ENVPAY_GLO_COMMON_SANDBOX_SECRET}"
      ENVPAY_GLO_HMPO_allALL2all_ACCOUNT="${ENVPAY_GLO_HMPO_allALL2all_ACCOUNT}"
      ENVPAY_GLO_HMPO_itALL2uk_ACCOUNT="${ENVPAY_GLO_HMPO_itALL2uk_ACCOUNT}"
      ENVPAY_GLO_BEgbALL2be_ACCOUNT="${ENVPAY_GLO_BEgbALL2be_ACCOUNT}"
      ENVPAY_GLO_COMMON_MERCHANT_ID="${ENVPAY_GLO_COMMON_MERCHANT_ID}"
      ENVPAY_GLO_COMMON_SECRET="${ENVPAY_GLO_COMMON_SECRET}"
      ENVPAY_PAY_COMMON_SANDBOX_ACCOUNT="${ENVPAY_PAY_COMMON_SANDBOX_ACCOUNT}"
      ENVPAY_PAY_BEruMOW2be_ACCOUNT="${ENVPAY_PAY_BEruMOW2be_ACCOUNT}"
      PAYU_NGALL2BE_SANDBOX_APP_ID="${PAYU_NGALL2BE_SANDBOX_APP_ID}"
      PAYU_NGALL2BE_SANDBOX_PRIVATE_KEY="${PAYU_NGALL2BE_SANDBOX_PRIVATE_KEY}"
      PAYU_KENYA_SANDBOX_APP_ID="${PAYU_KENYA_SANDBOX_APP_ID}"
      PAYU_KENYA_SANDBOX_PRIVATE_KEY="${PAYU_KENYA_SANDBOX_PRIVATE_KEY}"
      PAYU_NGALL2BE_APP_ID="${PAYU_NGALL2BE_APP_ID}"
      PAYU_NGALL2BE_PRIVATE_KEY="${PAYU_NGALL2BE_PRIVATE_KEY}"
      PAYU_KEALL2BE_APP_ID="${PAYU_KEALL2BE_APP_ID}"
      PAYU_KEALL2BE_PRIVATE_KEY="${PAYU_KEALL2BE_PRIVATE_KEY}"
      PAYU_KEALL2DE_APP_ID="${PAYU_KEALL2DE_APP_ID}"
      PAYU_KEALL2DE_PRIVATE_KEY="${PAYU_KEALL2DE_PRIVATE_KEY}"
      SANDBOX_PAYFORT_MERCHANT_ID="${SANDBOX_PAYFORT_MERCHANT_ID}"
      SANDBOX_PAYFORT_ACCESS_CODE="${SANDBOX_PAYFORT_ACCESS_CODE}"
      SANDBOX_PAYFORT_REQUEST_PHRASE="${SANDBOX_PAYFORT_REQUEST_PHRASE}"
      SANDBOX_PAYFORT_RESPONSE_PHRASE="${SANDBOX_PAYFORT_RESPONSE_PHRASE}"
      PAYFORT_MERCHANT_ID="${PAYFORT_MERCHANT_ID}"
      PAYFORT_ACCESS_CODE="${PAYFORT_ACCESS_CODE}"
      PAYFORT_REQUEST_PHRASE="${PAYFORT_REQUEST_PHRASE}"
      PAYFORT_RESPONSE_PHRASE="${PAYFORT_RESPONSE_PHRASE}"
      ENVPAY_GLO_FRuzTAS2fr_ACCOUNT="${ENVPAY_GLO_FRuzTAS2fr_ACCOUNT}"
      FAW_FRegAll2fr_MERCHANT_ID="${FAW_FRegAll2fr_MERCHANT_ID}"
      FAW_FRegAll2fr_SECURITY_KEY="${FAW_FRegAll2fr_SECURITY_KEY}"
      FAW_egCAI2fr_SANDBOX_MERCHANT_ID="${FAW_egCAI2fr_SANDBOX_MERCHANT_ID}"
      FAW_egCAI2fr_SANDBOX_SECURITY_KEY="${FAW_egCAI2fr_SANDBOX_SECURITY_KEY}"
      FAW_egCAI2fr_MERCHANT_ID="${FAW_egCAI2fr_MERCHANT_ID}"
      FAW_egCAI2fr_SECURITY_KEY="${FAW_egCAI2fr_SECURITY_KEY}"
      FAW_egALY2fr_SANDBOX_MERCHANT_ID="${FAW_egALY2fr_SANDBOX_MERCHANT_ID}"
      FAW_egALY2fr_SANDBOX_SECURITY_KEY="${FAW_egALY2fr_SANDBOX_SECURITY_KEY}"
      FAW_egALY2fr_MERCHANT_ID="${FAW_egALY2fr_MERCHANT_ID}"
      FAW_egALY2fr_SECURITY_KEY="${FAW_egALY2fr_SECURITY_KEY}"
      ALI_FRcnCAN2fr_APP_ID="${ALI_FRcnCAN2fr_APP_ID}"
      ALI_FRcnCAN2fr_PRIVATE_KEY="${ALI_FRcnCAN2fr_PRIVATE_KEY}"
      ALI_FRcnCAN2fr_PUBLIC_KEY="${ALI_FRcnCAN2fr_PUBLIC_KEY}"
      ALI_FRcnCNG2fr_APP_ID="${ALI_FRcnCNG2fr_APP_ID}"
      ALI_FRcnCNG2fr_PRIVATE_KEY="${ALI_FRcnCNG2fr_PRIVATE_KEY}"
      ALI_FRcnCNG2fr_PUBLIC_KEY="${ALI_FRcnCNG2fr_PUBLIC_KEY}"
      ALI_FRcnSHE2fr_APP_ID="${ALI_FRcnSHE2fr_APP_ID}"
      ALI_FRcnSHE2fr_PRIVATE_KEY="${ALI_FRcnSHE2fr_PRIVATE_KEY}"
      ALI_FRcnSHE2fr_PUBLIC_KEY="${ALI_FRcnSHE2fr_PUBLIC_KEY}"
      ALI_FRcnWUH2fr_APP_ID="${ALI_FRcnWUH2fr_APP_ID}"
      ALI_FRcnWUH2fr_PRIVATE_KEY="${ALI_FRcnWUH2fr_PRIVATE_KEY}"
      ALI_FRcnWUH2fr_PUBLIC_KEY="${ALI_FRcnWUH2fr_PUBLIC_KEY}"
      ALI_FRcnBJS2fr_APP_ID="${ALI_FRcnBJS2fr_APP_ID}"
      ALI_FRcnBJS2fr_PRIVATE_KEY="${ALI_FRcnBJS2fr_PRIVATE_KEY}"
      ALI_FRcnBJS2fr_PUBLIC_KEY="${ALI_FRcnBJS2fr_PUBLIC_KEY}"
      ALI_FRcnSHA2fr_APP_ID="${ALI_FRcnSHA2fr_APP_ID}"
      ALI_FRcnSHA2fr_PRIVATE_KEY="${ALI_FRcnSHA2fr_PRIVATE_KEY}"
      ALI_FRcnSHA2fr_PUBLIC_KEY="${ALI_FRcnSHA2fr_PUBLIC_KEY}"
      ENVPAY_GLO_FRgbALL2fr_ACCOUNT="${ENVPAY_GLO_FRgbALL2fr_ACCOUNT}"
      ENVPAY_BINGA_SANDBOX_MERCHANT_LOGIN="${ENVPAY_BINGA_SANDBOX_MERCHANT_LOGIN}"
      ENVPAY_BINGA_SANDBOX_MERCHANT_PASSWORD="${ENVPAY_BINGA_SANDBOX_MERCHANT_PASSWORD}"
      ENVPAY_BINGA_SANDBOX_STORE_ID="${ENVPAY_BINGA_SANDBOX_STORE_ID}"
      ENVPAY_BINGA_SANDBOX_STORE_PRIVATE_KEY="${ENVPAY_BINGA_SANDBOX_STORE_PRIVATE_KEY}"
      ENVPAY_BINGA_MERCHANT_LOGIN="${ENVPAY_BINGA_MERCHANT_LOGIN}"
      ENVPAY_BINGA_MERCHANT_PASSWORD="${ENVPAY_BINGA_MERCHANT_PASSWORD}"
      ENVPAY_BINGA_STORE_ID="${ENVPAY_BINGA_STORE_ID}"
      ENVPAY_BINGA_STORE_PRIVATE_KEY="${ENVPAY_BINGA_STORE_PRIVATE_KEY}"
      ENVPAY_CMI_FRmaAll2fr_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_FRmaAll2fr_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_FRmaAll2fr_SANDBOX_STOREKEY="${ENVPAY_CMI_FRmaAll2fr_SANDBOX_STOREKEY}"
      ENVPAY_CMI_FRmaAll2fr_MERCHANT_ID="${ENVPAY_CMI_FRmaAll2fr_MERCHANT_ID}"
      ENVPAY_CMI_FRmaAll2fr_STOREKEY="${ENVPAY_CMI_FRmaAll2fr_STOREKEY}"
      CLICTOPAY_FRtnAll2fr_SANDBOX_USER_NAME="${CLICTOPAY_FRtnAll2fr_SANDBOX_USER_NAME}"
      CLICTOPAY_FRtnAll2fr_SANDBOX_PASSWORD="${CLICTOPAY_FRtnAll2fr_SANDBOX_PASSWORD}"
      CLICTOPAY_FRtnAll2fr_USER_NAME="${CLICTOPAY_FRtnAll2fr_USER_NAME}"
      CLICTOPAY_FRtnAll2fr_PASSWORD="${CLICTOPAY_FRtnAll2fr_PASSWORD}"
      CLICTOPAY_SANDBOX_USER_NAME="${CLICTOPAY_SANDBOX_USER_NAME}"
      CLICTOPAY_SANDBOX_PASSWORD="${CLICTOPAY_SANDBOX_PASSWORD}"
      CLICTOPAY_USER_NAME="${CLICTOPAY_USER_NAME}"
      CLICTOPAY_PASSWORD="${CLICTOPAY_PASSWORD}"
      ENVPAY_CYBERSOURCE_SANDBOX_ACCESS_KEY="${ENVPAY_CYBERSOURCE_SANDBOX_ACCESS_KEY}"
      ENVPAY_CYBERSOURCE_SANDBOX_PROFILE_ID="${ENVPAY_CYBERSOURCE_SANDBOX_PROFILE_ID}"
      ENVPAY_CYBERSOURCE_SANDBOX_SECRET_KEY="${ENVPAY_CYBERSOURCE_SANDBOX_SECRET_KEY}"
      ENVPAY_CYBERSOURCE_SANDBOX_TRANSACTION_TYPE="${ENVPAY_CYBERSOURCE_SANDBOX_TRANSACTION_TYPE}"
      ENVPAY_CYBERSOURCE_ACCESS_KEY="${ENVPAY_CYBERSOURCE_ACCESS_KEY}"
      ENVPAY_CYBERSOURCE_PROFILE_ID="${ENVPAY_CYBERSOURCE_PROFILE_ID}"
      ENVPAY_CYBERSOURCE_SECRET_KEY="${ENVPAY_CYBERSOURCE_SECRET_KEY}"
      ENVPAY_CYBERSOURCE_TRANSACTION_TYPE="${ENVPAY_CYBERSOURCE_TRANSACTION_TYPE}"
      BANK_PAYMENT_SECRET="${BANK_PAYMENT_SECRET}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_HOST="${ENVPAY_PAYSOFT_COMMON_SANDBOX_HOST}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_MERCHANT_ID="${ENVPAY_PAYSOFT_COMMON_SANDBOX_MERCHANT_ID}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_ALGORITHM="${ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_ALGORITHM}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_SECRET_KEY="${ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_SECRET_KEY}"
      ENVPAY_PAYSOFT_uaKBP2pl_HOST="${ENVPAY_PAYSOFT_uaKBP2pl_HOST}"
      ENVPAY_PAYSOFT_uaKBP2pl_MERCHANT_ID="${ENVPAY_PAYSOFT_uaKBP2pl_MERCHANT_ID}"
      ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_ALGORITHM="${ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_ALGORITHM}"
      ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_SECRET_KEY="${ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_SECRET_KEY}"
      ENVPAY_PAY_BEzaALL2be_ACCOUNT="${ENVPAY_PAY_BEzaALL2be_ACCOUNT}"
      ENVPAY_PAY_CHphMNL2ch_ACCOUNT="${ENVPAY_PAY_CHphMNL2ch_ACCOUNT}"
      ENVPAY_PAYGATE_ZAALL2DE_ENCRYPTION_KEY="${ENVPAY_PAYGATE_ZAALL2DE_ENCRYPTION_KEY}"
      ENVPAY_PAYGATE_ZAALL2DE_ID="${ENVPAY_PAYGATE_ZAALL2DE_ID}"
      ENVPAY_PAYGATE_ZAALL2DE_SELLER_EMAIL="${ENVPAY_PAYGATE_ZAALL2DE_SELLER_EMAIL}"
      ENVPAY_GLO_DEgbALL2de_ACCOUNT="${ENVPAY_GLO_DEgbALL2de_ACCOUNT}"
      MEMORY_REQUEST="${MEMORY_REQUEST}"
      MEMORY_LIMIT="${MEMORY_LIMIT}"
      CPU_REQUEST="${CPU_REQUEST}"
      ENVPAY_SWITCH_COMMON_SANDBOX_HOST="${ENVPAY_SWITCH_COMMON_SANDBOX_HOST}"
      ENVPAY_SWITCH_COMMON_SANDBOX_ENTITY_ID="${ENVPAY_SWITCH_COMMON_SANDBOX_ENTITY_ID}"
      ENVPAY_SWITCH_COMMON_SANDBOX_ACCESS_TOKEN="${ENVPAY_SWITCH_COMMON_SANDBOX_ACCESS_TOKEN}"
      ENVPAY_SWITCH_iqAll2be_HOST="${ENVPAY_SWITCH_iqAll2be_HOST}"
      ENVPAY_SWITCH_iqAll2be_ENTITY_ID="${ENVPAY_SWITCH_iqAll2be_ENTITY_ID}"
      ENVPAY_SWITCH_iqAll2be_ACCESS_TOKEN="${ENVPAY_SWITCH_iqAll2be_ACCESS_TOKEN}"
      ALIPAY_PRODUCT_CODE="${ALIPAY_PRODUCT_CODE}"
      ALIPAY_METHOD="${ALIPAY_METHOD}"
      ALIPAY_SANDBOX_APP_ID="${ALIPAY_SANDBOX_APP_ID}"
      ALIPAY_SANDBOX_GATEWAY="${ALIPAY_SANDBOX_GATEWAY}"
      ALIPAY_SANDBOX_PRIVATE_KEY="${ALIPAY_SANDBOX_PRIVATE_KEY}"
      ALIPAY_SANDBOX_PUBLIC_KEY="${ALIPAY_SANDBOX_PUBLIC_KEY}"
      ALI_DEcnBJS2de_APP_ID="${ALI_DEcnBJS2de_APP_ID}"
      ALIPAY_GATEWAY="${ALIPAY_GATEWAY}"
      ALI_DEcnBJS2de_PRIVATE_KEY="${ALI_DEcnBJS2de_PRIVATE_KEY}"
      ALI_DEcnBJS2de_PUBLIC_KEY="${ALI_DEcnBJS2de_PUBLIC_KEY}"
      ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_HOST="${ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_HOST}"
      ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_USER_NAME="${ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_USER_NAME}"
      ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_PASSWORD="${ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_PASSWORD}"
      ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_TERMINAL_ID="${ENVPAY_BNP_PARIBAS_COMMON_SANDBOX_TERMINAL_ID}"
      ENVPAY_BNP_PARIBAS_dzALL2fr_HOST="${ENVPAY_BNP_PARIBAS_dzALL2fr_HOST}"
      ENVPAY_BNP_PARIBAS_dzALL2fr_USER_NAME="${ENVPAY_BNP_PARIBAS_dzALL2fr_USER_NAME}"
      ENVPAY_BNP_PARIBAS_dzALL2fr_PASSWORD="${ENVPAY_BNP_PARIBAS_dzALL2fr_PASSWORD}"
      ENVPAY_BNP_PARIBAS_dzALL2fr_TERMINAL_ID="${ENVPAY_BNP_PARIBAS_dzALL2fr_TERMINAL_ID}"
      EMAIL_SERVICE_DOMAIN="${EMAIL_SERVICE_DOMAIN}"
      FAW_egAll2de_LEGALIZATION_SANDBOX_MERCHANT_ID=$FAW_egAll2de_LEGALIZATION_SANDBOX_MERCHANT_ID
      FAW_egAll2de_LEGALIZATION_SANDBOX_SECURITY_KEY=$FAW_egAll2de_LEGALIZATION_SANDBOX_SECURITY_KEY
      FAW_egAll2de_LEGALIZATION_MERCHANT_ID=$FAW_egAll2de_LEGALIZATION_MERCHANT_ID
      FAW_egAll2de_LEGALIZATION_SECURITY_KEY=$FAW_egAll2de_LEGALIZATION_SECURITY_KEY
      HOSTNAME_HTTPS="${HOSTNAME_HTTPS}" | oc apply -f -
    - oc start-build ${APPLICATION_NAME} --from-dir=. --follow -w
    - oc rollout status dc/${APPLICATION_NAME} -w
    - oc process -f ./openshift/payment-fawry-queue-template.yaml
      APPLICATION_NAME="${APPLICATION_NAME}"
      PROJECT="${INSTANCE}"
      NAMESPACE="${PROJECT}"
      APP_ENV="${APP_ENV}"
      OPENSHIFT_ENV="${ENV}"
      ROUTE_IP_WHITE_LIST="${ROUTE_IP_WHITE_LIST}"
      POSTGRES_DB_HOST="pgbouncer"
      POSTGRES_SECRET_NAME="${PROJECT}-pgcluster-common-secret"
      POSTGRES_ADMIN_SECRET_NAME="${PROJECT}-pgsql-master"
      POSTGRES_PAYMENT_DB_DATABASE="payment-${DATABASE}"
      AWS_ACCOUNT_S3="tlspay-s3-account"
      PAYMENT_SERVICE_DOMAIN="https://${PAYMENT_SERVICE_URL}"
      DIRECTUS_DOMAIN="https://${DIRECTUS_HOST}"
      REDIS_HOST="tls://${REDIS_HOST}"
      TLSCONTACT_API="${TLSCONNECT_API_URL}"
      CLIENT="${CLIENT}"
      KBANK_THBKK2BE_SANDBOX_API_KEY="${KBANK_THBKK2BE_SANDBOX_API_KEY}"
      KBANK_THBKK2BE_SANDBOX_SECRET="${KBANK_THBKK2BE_SANDBOX_SECRET}"
      KBANK_THBKK2BE_SANDBOX_MID="${KBANK_THBKK2BE_SANDBOX_MID}"
      KBANK_THBKK2BE_API_KEY="${KBANK_THBKK2BE_API_KEY}"
      KBANK_THBKK2BE_SECRET="${KBANK_THBKK2BE_SECRET}"
      KBANK_THBKK2BE_MID="${KBANK_THBKK2BE_MID}"
      ENVPAY_CMI_BEmaAll2be_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_BEmaAll2be_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_BEmaAll2be_SANDBOX_STOREKEY="${ENVPAY_CMI_BEmaAll2be_SANDBOX_STOREKEY}"
      ENVPAY_CMI_BEmaAll2be_MERCHANT_ID="${ENVPAY_CMI_BEmaAll2be_MERCHANT_ID}"
      ENVPAY_CMI_BEmaAll2be_STOREKEY="${ENVPAY_CMI_BEmaAll2be_STOREKEY}"
      ENVPAY_CMI_DEmaAll2de_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_DEmaAll2de_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_DEmaAll2de_SANDBOX_STOREKEY="${ENVPAY_CMI_DEmaAll2de_SANDBOX_STOREKEY}"
      ENVPAY_CMI_DEmaAll2de_MERCHANT_ID="${ENVPAY_CMI_DEmaAll2de_MERCHANT_ID}"
      ENVPAY_CMI_DEmaAll2de_STOREKEY="${ENVPAY_CMI_DEmaAll2de_STOREKEY}"
      ENVPAY_YOOKASSA_COMMON_SANDBOX_SHOP_ID="${ENVPAY_YOOKASSA_COMMON_SANDBOX_SHOP_ID}"
      ENVPAY_YOOKASSA_COMMON_SANDBOX_SECRET="${ENVPAY_YOOKASSA_COMMON_SANDBOX_SECRET}"
      ENVPAY_YOOKASSA_COMMON_SHOP_ID="${ENVPAY_YOOKASSA_COMMON_SHOP_ID}"
      ENVPAY_YOOKASSA_COMMON_SECRET="${ENVPAY_YOOKASSA_COMMON_SECRET}"
      ENVPAY_TINGG_COMMON_SANDBOX_ACCOUNT_NUMBER="${ENVPAY_TINGG_COMMON_SANDBOX_ACCOUNT_NUMBER}"
      ENVPAY_TINGG_COMMON_SANDBOX_SERVICE_CODE="${ENVPAY_TINGG_COMMON_SANDBOX_SERVICE_CODE}"
      ENVPAY_TINGG_COMMON_SANDBOX_IVKEY="${ENVPAY_TINGG_COMMON_SANDBOX_IVKEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_SECRET_KEY="${ENVPAY_TINGG_COMMON_SANDBOX_SECRET_KEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_ACCESS_KEY="${ENVPAY_TINGG_COMMON_SANDBOX_ACCESS_KEY}"
      ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_ID="${ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_ID}"
      ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_SECRET="${ENVPAY_TINGG_COMMON_SANDBOX_CLIENT_SECRET}"
      ENVPAY_TINGG_COMMON_SANDBOX_OAUTH_HOST="${ENVPAY_TINGG_COMMON_SANDBOX_OAUTH_HOST}"
      ENVPAY_TINGG_COMMON_SANDBOX_QUERY_STATUS_HOST="${ENVPAY_TINGG_COMMON_SANDBOX_QUERY_STATUS_HOST}"
      ENVPAY_TINGG_COMMON_ACCOUNT_NUMBER="${ENVPAY_TINGG_COMMON_ACCOUNT_NUMBER}"
      ENVPAY_TINGG_COMMON_SERVICE_CODE="${ENVPAY_TINGG_COMMON_SERVICE_CODE}"
      ENVPAY_TINGG_COMMON_IVKEY="${ENVPAY_TINGG_COMMON_IVKEY}"
      ENVPAY_TINGG_COMMON_SECRET_KEY="${ENVPAY_TINGG_COMMON_SECRET_KEY}"
      ENVPAY_TINGG_COMMON_ACCESS_KEY="${ENVPAY_TINGG_COMMON_ACCESS_KEY}"
      ENVPAY_TINGG_COMMON_CLIENT_ID="${ENVPAY_TINGG_COMMON_CLIENT_ID}"
      ENVPAY_TINGG_COMMON_CLIENT_SECRET="${ENVPAY_TINGG_COMMON_CLIENT_SECRET}"
      ENVPAY_TINGG_COMMON_OAUTH_HOST="${ENVPAY_TINGG_COMMON_OAUTH_HOST}"
      ENVPAY_TINGG_COMMON_QUERY_STATUS_HOST="${ENVPAY_TINGG_COMMON_QUERY_STATUS_HOST}"
      ENVPAY_TINGG_DEtzDAR2de_SERVICE_CODE="${ENVPAY_TINGG_DEtzDAR2de_SERVICE_CODE}"
      ENVPAY_TINGG_DEtzDAR2de_IVKEY="${ENVPAY_TINGG_DEtzDAR2de_IVKEY}"
      ENVPAY_TINGG_DEtzDAR2de_SECRET_KEY="${ENVPAY_TINGG_DEtzDAR2de_SECRET_KEY}"
      ENVPAY_TINGG_DEtzDAR2de_ACCESS_KEY="${ENVPAY_TINGG_DEtzDAR2de_ACCESS_KEY}"
      PAYGATE_ZAALL2BE_ENCRYPTION_SANDBOX_KEY="${PAYGATE_ZAALL2BE_ENCRYPTION_SANDBOX_KEY}"
      PAYGATE_ZAALL2BE_SANDBOX_ID="${PAYGATE_ZAALL2BE_SANDBOX_ID}"
      PAYGATE_ZAALL2BE_ENCRYPTION_KEY="${PAYGATE_ZAALL2BE_ENCRYPTION_KEY}"
      PAYGATE_ZAALL2BE_ID="${PAYGATE_ZAALL2BE_ID}"
      PAYGATE_ZAALL2BE_SELLER_EMAIL="${PAYGATE_ZAALL2BE_SELLER_EMAIL}"
      FAW_COMMON_SANDBOX_MERCHANT_ID="${FAW_COMMON_SANDBOX_MERCHANT_ID}"
      FAW_COMMON_SANDBOX_SECRET_KEY="${FAW_COMMON_SANDBOX_SECRET_KEY}"
      FAW_DEegAll2de_SANDBOX_MERCHANT_ID="${FAW_DEegAll2de_SANDBOX_MERCHANT_ID}"
      FAW_DEegAll2de_SANDBOX_SECRET_KEY="${FAW_DEegAll2de_SANDBOX_SECRET_KEY}"
      FAW_DEegCAI2de_MERCHANT_ID="${FAW_DEegCAI2de_MERCHANT_ID}"
      FAW_DEegCAI2de_SECRET_KEY="${FAW_DEegCAI2de_SECRET_KEY}"
      FAW_DEegALY2de_MERCHANT_ID="${FAW_DEegALY2de_MERCHANT_ID}"
      FAW_DEegALY2de_SECRET_KEY="${FAW_DEegALY2de_SECRET_KEY}"
      FAW_DEegHRG2de_MERCHANT_ID="${FAW_DEegHRG2de_MERCHANT_ID}"
      FAW_DEegHRG2de_SECRET_KEY="${FAW_DEegHRG2de_SECRET_KEY}"
      FAW_FRegAll2fr_SANDBOX_MERCHANT_ID="${FAW_FRegAll2fr_SANDBOX_MERCHANT_ID}"
      FAW_FRegAll2fr_SANDBOX_SECRET_KEY="${FAW_FRegAll2fr_SANDBOX_SECRET_KEY}"
      FAW_egAll2be_MERCHANT_ID="${FAW_egAll2be_MERCHANT_ID}"
      FAW_egAll2be_SECURITY_KEY="${FAW_egAll2be_SECURITY_KEY}"
      ENVPAY_GLO_COMMON_SANDBOX_MERCHANT_ID="${ENVPAY_GLO_COMMON_SANDBOX_MERCHANT_ID}"
      ENVPAY_GLO_COMMON_SANDBOX_SECRET="${ENVPAY_GLO_COMMON_SANDBOX_SECRET}"
      ENVPAY_GLO_HMPO_allALL2all_ACCOUNT="${ENVPAY_GLO_HMPO_allALL2all_ACCOUNT}"
      ENVPAY_GLO_HMPO_itALL2uk_ACCOUNT="${ENVPAY_GLO_HMPO_itALL2uk_ACCOUNT}"
      ENVPAY_GLO_BEgbALL2be_ACCOUNT="${ENVPAY_GLO_BEgbALL2be_ACCOUNT}"
      ENVPAY_GLO_COMMON_MERCHANT_ID="${ENVPAY_GLO_COMMON_MERCHANT_ID}"
      ENVPAY_GLO_COMMON_SECRET="${ENVPAY_GLO_COMMON_SECRET}"
      ENVPAY_PAY_COMMON_SANDBOX_ACCOUNT="${ENVPAY_PAY_COMMON_SANDBOX_ACCOUNT}"
      ENVPAY_PAY_BEruMOW2be_ACCOUNT="${ENVPAY_PAY_BEruMOW2be_ACCOUNT}"
      PAYU_NGALL2BE_SANDBOX_APP_ID="${PAYU_NGALL2BE_SANDBOX_APP_ID}"
      PAYU_NGALL2BE_SANDBOX_PRIVATE_KEY="${PAYU_NGALL2BE_SANDBOX_PRIVATE_KEY}"
      PAYU_KENYA_SANDBOX_APP_ID="${PAYU_KENYA_SANDBOX_APP_ID}"
      PAYU_KENYA_SANDBOX_PRIVATE_KEY="${PAYU_KENYA_SANDBOX_PRIVATE_KEY}"
      PAYU_NGALL2BE_APP_ID="${PAYU_NGALL2BE_APP_ID}"
      PAYU_NGALL2BE_PRIVATE_KEY="${PAYU_NGALL2BE_PRIVATE_KEY}"
      PAYU_KEALL2BE_APP_ID="${PAYU_KEALL2BE_APP_ID}"
      PAYU_KEALL2BE_PRIVATE_KEY="${PAYU_KEALL2BE_PRIVATE_KEY}"
      PAYU_KEALL2DE_APP_ID="${PAYU_KEALL2DE_APP_ID}"
      PAYU_KEALL2DE_PRIVATE_KEY="${PAYU_KEALL2DE_PRIVATE_KEY}"
      SANDBOX_PAYFORT_MERCHANT_ID="${SANDBOX_PAYFORT_MERCHANT_ID}"
      SANDBOX_PAYFORT_ACCESS_CODE="${SANDBOX_PAYFORT_ACCESS_CODE}"
      SANDBOX_PAYFORT_REQUEST_PHRASE="${SANDBOX_PAYFORT_REQUEST_PHRASE}"
      SANDBOX_PAYFORT_RESPONSE_PHRASE="${SANDBOX_PAYFORT_RESPONSE_PHRASE}"
      PAYFORT_MERCHANT_ID="${PAYFORT_MERCHANT_ID}"
      PAYFORT_ACCESS_CODE="${PAYFORT_ACCESS_CODE}"
      PAYFORT_REQUEST_PHRASE="${PAYFORT_REQUEST_PHRASE}"
      PAYFORT_RESPONSE_PHRASE="${PAYFORT_RESPONSE_PHRASE}"
      ENVPAY_GLO_FRuzTAS2fr_ACCOUNT="${ENVPAY_GLO_FRuzTAS2fr_ACCOUNT}"
      FAW_FRegAll2fr_MERCHANT_ID="${FAW_FRegAll2fr_MERCHANT_ID}"
      FAW_FRegAll2fr_SECURITY_KEY="${FAW_FRegAll2fr_SECURITY_KEY}"
      FAW_egCAI2fr_SANDBOX_MERCHANT_ID="${FAW_egCAI2fr_SANDBOX_MERCHANT_ID}"
      FAW_egCAI2fr_SANDBOX_SECURITY_KEY="${FAW_egCAI2fr_SANDBOX_SECURITY_KEY}"
      FAW_egCAI2fr_MERCHANT_ID="${FAW_egCAI2fr_MERCHANT_ID}"
      FAW_egCAI2fr_SECURITY_KEY="${FAW_egCAI2fr_SECURITY_KEY}"
      FAW_egALY2fr_SANDBOX_MERCHANT_ID="${FAW_egALY2fr_SANDBOX_MERCHANT_ID}"
      FAW_egALY2fr_SANDBOX_SECURITY_KEY="${FAW_egALY2fr_SANDBOX_SECURITY_KEY}"
      FAW_egALY2fr_MERCHANT_ID="${FAW_egALY2fr_MERCHANT_ID}"
      FAW_egALY2fr_SECURITY_KEY="${FAW_egALY2fr_SECURITY_KEY}"
      ALI_FRcnCAN2fr_APP_ID="${ALI_FRcnCAN2fr_APP_ID}"
      ALI_FRcnCAN2fr_PRIVATE_KEY="${ALI_FRcnCAN2fr_PRIVATE_KEY}"
      ALI_FRcnCAN2fr_PUBLIC_KEY="${ALI_FRcnCAN2fr_PUBLIC_KEY}"
      ALI_FRcnCNG2fr_APP_ID="${ALI_FRcnCNG2fr_APP_ID}"
      ALI_FRcnCNG2fr_PRIVATE_KEY="${ALI_FRcnCNG2fr_PRIVATE_KEY}"
      ALI_FRcnCNG2fr_PUBLIC_KEY="${ALI_FRcnCNG2fr_PUBLIC_KEY}"
      ALI_FRcnSHE2fr_APP_ID="${ALI_FRcnSHE2fr_APP_ID}"
      ALI_FRcnSHE2fr_PRIVATE_KEY="${ALI_FRcnSHE2fr_PRIVATE_KEY}"
      ALI_FRcnSHE2fr_PUBLIC_KEY="${ALI_FRcnSHE2fr_PUBLIC_KEY}"
      ALI_FRcnWUH2fr_APP_ID="${ALI_FRcnWUH2fr_APP_ID}"
      ALI_FRcnWUH2fr_PRIVATE_KEY="${ALI_FRcnWUH2fr_PRIVATE_KEY}"
      ALI_FRcnWUH2fr_PUBLIC_KEY="${ALI_FRcnWUH2fr_PUBLIC_KEY}"
      ALI_FRcnBJS2fr_APP_ID="${ALI_FRcnBJS2fr_APP_ID}"
      ALI_FRcnBJS2fr_PRIVATE_KEY="${ALI_FRcnBJS2fr_PRIVATE_KEY}"
      ALI_FRcnBJS2fr_PUBLIC_KEY="${ALI_FRcnBJS2fr_PUBLIC_KEY}"
      ALI_FRcnSHA2fr_APP_ID="${ALI_FRcnSHA2fr_APP_ID}"
      ALI_FRcnSHA2fr_PRIVATE_KEY="${ALI_FRcnSHA2fr_PRIVATE_KEY}"
      ALI_FRcnSHA2fr_PUBLIC_KEY="${ALI_FRcnSHA2fr_PUBLIC_KEY}"
      ENVPAY_GLO_FRgbALL2fr_ACCOUNT="${ENVPAY_GLO_FRgbALL2fr_ACCOUNT}"
      ENVPAY_BINGA_SANDBOX_MERCHANT_LOGIN="${ENVPAY_BINGA_SANDBOX_MERCHANT_LOGIN}"
      ENVPAY_BINGA_SANDBOX_MERCHANT_PASSWORD="${ENVPAY_BINGA_SANDBOX_MERCHANT_PASSWORD}"
      ENVPAY_BINGA_SANDBOX_STORE_ID="${ENVPAY_BINGA_SANDBOX_STORE_ID}"
      ENVPAY_BINGA_SANDBOX_STORE_PRIVATE_KEY="${ENVPAY_BINGA_SANDBOX_STORE_PRIVATE_KEY}"
      ENVPAY_BINGA_MERCHANT_LOGIN="${ENVPAY_BINGA_MERCHANT_LOGIN}"
      ENVPAY_BINGA_MERCHANT_PASSWORD="${ENVPAY_BINGA_MERCHANT_PASSWORD}"
      ENVPAY_BINGA_STORE_ID="${ENVPAY_BINGA_STORE_ID}"
      ENVPAY_BINGA_STORE_PRIVATE_KEY="${ENVPAY_BINGA_STORE_PRIVATE_KEY}"
      ENVPAY_CMI_FRmaAll2fr_SANDBOX_MERCHANT_ID="${ENVPAY_CMI_FRmaAll2fr_SANDBOX_MERCHANT_ID}"
      ENVPAY_CMI_FRmaAll2fr_SANDBOX_STOREKEY="${ENVPAY_CMI_FRmaAll2fr_SANDBOX_STOREKEY}"
      ENVPAY_CMI_FRmaAll2fr_MERCHANT_ID="${ENVPAY_CMI_FRmaAll2fr_MERCHANT_ID}"
      ENVPAY_CMI_FRmaAll2fr_STOREKEY="${ENVPAY_CMI_FRmaAll2fr_STOREKEY}"
      CLICTOPAY_FRtnAll2fr_SANDBOX_USER_NAME="${CLICTOPAY_FRtnAll2fr_SANDBOX_USER_NAME}"
      CLICTOPAY_FRtnAll2fr_SANDBOX_PASSWORD="${CLICTOPAY_FRtnAll2fr_SANDBOX_PASSWORD}"
      CLICTOPAY_FRtnAll2fr_USER_NAME="${CLICTOPAY_FRtnAll2fr_USER_NAME}"
      CLICTOPAY_FRtnAll2fr_PASSWORD="${CLICTOPAY_FRtnAll2fr_PASSWORD}"
      CLICTOPAY_SANDBOX_USER_NAME="${CLICTOPAY_SANDBOX_USER_NAME}"
      CLICTOPAY_SANDBOX_PASSWORD="${CLICTOPAY_SANDBOX_PASSWORD}"
      CLICTOPAY_USER_NAME="${CLICTOPAY_USER_NAME}"
      CLICTOPAY_PASSWORD="${CLICTOPAY_PASSWORD}"
      ENVPAY_CYBERSOURCE_SANDBOX_ACCESS_KEY="${ENVPAY_CYBERSOURCE_SANDBOX_ACCESS_KEY}"
      ENVPAY_CYBERSOURCE_SANDBOX_PROFILE_ID="${ENVPAY_CYBERSOURCE_SANDBOX_PROFILE_ID}"
      ENVPAY_CYBERSOURCE_SANDBOX_SECRET_KEY="${ENVPAY_CYBERSOURCE_SANDBOX_SECRET_KEY}"
      ENVPAY_CYBERSOURCE_SANDBOX_TRANSACTION_TYPE="${ENVPAY_CYBERSOURCE_SANDBOX_TRANSACTION_TYPE}"
      ENVPAY_CYBERSOURCE_ACCESS_KEY="${ENVPAY_CYBERSOURCE_ACCESS_KEY}"
      ENVPAY_CYBERSOURCE_PROFILE_ID="${ENVPAY_CYBERSOURCE_PROFILE_ID}"
      ENVPAY_CYBERSOURCE_SECRET_KEY="${ENVPAY_CYBERSOURCE_SECRET_KEY}"
      ENVPAY_CYBERSOURCE_TRANSACTION_TYPE="${ENVPAY_CYBERSOURCE_TRANSACTION_TYPE}"
      BANK_PAYMENT_SECRET="${BANK_PAYMENT_SECRET}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_HOST="${ENVPAY_PAYSOFT_COMMON_SANDBOX_HOST}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_MERCHANT_ID="${ENVPAY_PAYSOFT_COMMON_SANDBOX_MERCHANT_ID}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_ALGORITHM="${ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_ALGORITHM}"
      ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_SECRET_KEY="${ENVPAY_PAYSOFT_COMMON_SANDBOX_SIGNATURE_SECRET_KEY}"
      ENVPAY_PAYSOFT_uaKBP2pl_HOST="${ENVPAY_PAYSOFT_uaKBP2pl_HOST}"
      ENVPAY_PAYSOFT_uaKBP2pl_MERCHANT_ID="${ENVPAY_PAYSOFT_uaKBP2pl_MERCHANT_ID}"
      ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_ALGORITHM="${ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_ALGORITHM}"
      ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_SECRET_KEY="${ENVPAY_PAYSOFT_uaKBP2pl_SIGNATURE_SECRET_KEY}"
      ENVPAY_PAY_BEzaALL2be_ACCOUNT="${ENVPAY_PAY_BEzaALL2be_ACCOUNT}"
      ENVPAY_PAY_CHphMNL2ch_ACCOUNT="${ENVPAY_PAY_CHphMNL2ch_ACCOUNT}"
      ENVPAY_PAYGATE_ZAALL2DE_ENCRYPTION_KEY="${ENVPAY_PAYGATE_ZAALL2DE_ENCRYPTION_KEY}"
      ENVPAY_PAYGATE_ZAALL2DE_ID="${ENVPAY_PAYGATE_ZAALL2DE_ID}"
      ENVPAY_PAYGATE_ZAALL2DE_SELLER_EMAIL="${ENVPAY_PAYGATE_ZAALL2DE_SELLER_EMAIL}"
      ENVPAY_GLO_DEgbALL2de_ACCOUNT="${ENVPAY_GLO_DEgbALL2de_ACCOUNT}"
      MEMORY_REQUEST="${MEMORY_REQUEST}"
      MEMORY_LIMIT="${MEMORY_LIMIT}"
      CPU_REQUEST="${CPU_REQUEST}"
      ENVPAY_SWITCH_COMMON_SANDBOX_HOST="${ENVPAY_SWITCH_COMMON_SANDBOX_HOST}"
      ENVPAY_SWITCH_COMMON_SANDBOX_ENTITY_ID="${ENVPAY_SWITCH_COMMON_SANDBOX_ENTITY_ID}"
      ENVPAY_SWITCH_COMMON_SANDBOX_ACCESS_TOKEN="${ENVPAY_SWITCH_COMMON_SANDBOX_ACCESS_TOKEN}"
      ENVPAY_SWITCH_iqAll2be_HOST="${ENVPAY_SWITCH_iqAll2be_HOST}"
      ENVPAY_SWITCH_iqAll2be_ENTITY_ID="${ENVPAY_SWITCH_iqAll2be_ENTITY_ID}"
      ENVPAY_SWITCH_iqAll2be_ACCESS_TOKEN="${ENVPAY_SWITCH_iqAll2be_ACCESS_TOKEN}"
      ALIPAY_PRODUCT_CODE="${ALIPAY_PRODUCT_CODE}"
      ALIPAY_METHOD="${ALIPAY_METHOD}"
      ALIPAY_SANDBOX_APP_ID="${ALIPAY_SANDBOX_APP_ID}"
      ALIPAY_SANDBOX_GATEWAY="${ALIPAY_SANDBOX_GATEWAY}"
      ALIPAY_SANDBOX_PRIVATE_KEY="${ALIPAY_SANDBOX_PRIVATE_KEY}"
      ALIPAY_SANDBOX_PUBLIC_KEY="${ALIPAY_SANDBOX_PUBLIC_KEY}"
      ALI_DEcnBJS2de_APP_ID="${ALI_DEcnBJS2de_APP_ID}"
      ALIPAY_GATEWAY="${ALIPAY_GATEWAY}"
      ALI_DEcnBJS2de_PRIVATE_KEY="${ALI_DEcnBJS2de_PRIVATE_KEY}"
      ALI_DEcnBJS2de_PUBLIC_KEY="${ALI_DEcnBJS2de_PUBLIC_KEY}"
      FAW_egAll2de_LEGALIZATION_SANDBOX_MERCHANT_ID=$FAW_egAll2de_LEGALIZATION_SANDBOX_MERCHANT_ID
      FAW_egAll2de_LEGALIZATION_SANDBOX_SECURITY_KEY=$FAW_egAll2de_LEGALIZATION_SANDBOX_SECURITY_KEY
      FAW_egAll2de_LEGALIZATION_MERCHANT_ID=$FAW_egAll2de_LEGALIZATION_MERCHANT_ID
      FAW_egAll2de_LEGALIZATION_SECURITY_KEY=$FAW_egAll2de_LEGALIZATION_SECURITY_KEY
      HOSTNAME_HTTPS="${HOSTNAME_HTTPS}" | oc apply -f -
    - oc process -f ./openshift/payment-api-eauditor-log-queue-template.yaml
      APPLICATION_NAME="${APPLICATION_NAME}"
      PROJECT="${INSTANCE}"
      NAMESPACE="${PROJECT}"
      APP_ENV="${APP_ENV}"
      OPENSHIFT_ENV="${ENV}"
      ROUTE_IP_WHITE_LIST="${ROUTE_IP_WHITE_LIST}"
      POSTGRES_DB_HOST="pgbouncer"
      POSTGRES_SECRET_NAME="${PROJECT}-pgcluster-common-secret"
      POSTGRES_ADMIN_SECRET_NAME="${PROJECT}-pgsql-master"
      POSTGRES_PAYMENT_DB_DATABASE="payment-${DATABASE}"
      TLSCONTACT_EAUDITOR_DOMAIN="${TLSCONTACT_EAUDITOR_DOMAIN}"
      TLSCONTACT_EAUDITOR_PORT="${TLSCONTACT_EAUDITOR_PORT}"
      AWS_ACCOUNT_S3="tlspay-s3-account"
      MEMORY_REQUEST="${MEMORY_REQUEST}"
      MEMORY_LIMIT="${MEMORY_LIMIT}"
      CPU_REQUEST="${CPU_REQUEST}"
      DIRECTUS_DOMAIN="https://${DIRECTUS_HOST}"
      REDIS_HOST="tls://${REDIS_HOST}"
      TLSCONTACT_API="${TLSCONNECT_API_URL}"
      CLIENT="${CLIENT}"
      HOSTNAME_HTTPS="${HOSTNAME_HTTPS}" | oc apply -f -
    - echo "Deploy cronjobs"
    - oc process -f ./openshift/payment-api-cronjob.yaml JOB_NAME=cronjob APPLICATION_NAME="${APPLICATION_NAME}"
      SCHEDULE="* * * * *" | oc apply -f -
    - oc process -f ./openshift/payment-api-sync-transaction-queue-template.yaml
      APPLICATION_NAME="${APPLICATION_NAME}"
      PROJECT="${INSTANCE}"
      NAMESPACE="${PROJECT}"
      APP_ENV="${APP_ENV}"
      OPENSHIFT_ENV="${ENV}"
      ROUTE_IP_WHITE_LIST="${ROUTE_IP_WHITE_LIST}"
      POSTGRES_DB_HOST="pgbouncer"
      POSTGRES_SECRET_NAME="${PROJECT}-pgcluster-common-secret"
      POSTGRES_ADMIN_SECRET_NAME="${PROJECT}-pgsql-master"
      POSTGRES_PAYMENT_DB_DATABASE="payment-${DATABASE}"
      AWS_ACCOUNT_S3="tlspay-s3-account"
      MEMORY_REQUEST="${MEMORY_REQUEST}"
      MEMORY_LIMIT="${MEMORY_LIMIT}"
      CPU_REQUEST="${CPU_REQUEST}"
      DIRECTUS_DOMAIN="https://${DIRECTUS_HOST}"
      REDIS_HOST="tls://${REDIS_HOST}"
      TLSCONTACT_API="${TLSCONNECT_API_URL}"
      CLIENT="${CLIENT}"
      HOSTNAME_HTTPS="${HOSTNAME_HTTPS}" | oc apply -f -
  environment:
    name: $ENV
  rules:
    - if: $ENV == null || $PROJECT == null || $ROLLBACK != null || $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $AUTODEPLOY == "true"
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "staging"
    - when: manual
      allow_failure: true

rollback:
  extends: .rollback
  dependencies: []
  script:
    - oc rollout undo dc/${APPLICATION_NAME}
  rules:
    - if: $ROLLBACK == "true"

sast:
  stage: test
  variables:
    SAST_EXCLUDED_PATHS: spec, test, tests, tmp, vendor

dast:
  stage: post
  extends: .dast-template-api
  variables:
    DAST_PORT: 8443
    DAST_API_HOST_OVERRIDE: http://localhost:${DAST_PORT}
    DAST_API_OPENAPI: http://localhost:${DAST_PORT}/docs

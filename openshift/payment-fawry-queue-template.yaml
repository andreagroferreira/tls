apiVersion: v1
kind: Template
metadata:
  name: payment-template
  annotations:
    description: This template defines objects that are required to spin up a TLS Connect application
parameters:
  - name: APPLICATION_NAME
    description: Name of the application
    required: true
    displayName: Application Name
  - name: POSTGRES_SECRET_NAME
    required: true
  - name: POSTGRES_ADMIN_SECRET_NAME
    required: true
  - name: POSTGRES_DB_HOST
    required: true
  - name: POSTGRES_PAYMENT_DB_DATABASE
    required: true
  - name: TLSCONTACT_API
    required: true
  - name: AWS_ACCOUNT_S3
    required: true
  - name: PAYMENT_SERVICE_DOMAIN
    required: true
  - name: APPLICATION_ENV
    value: prod
    required: true
  - name: APP_ENV
    required: true
  - name: PROJECT
    required: true
  - name: OPENSHIFT_ENV
    required: true
  - name: NAMESPACE
    required: true
  - name: ROUTE_IP_WHITE_LIST
    required: true
  - name: IMAGE_TAG
    value: latest
  - name: VERIFYPEER
    required: true
    value: "/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt"
  - name: DEBUG_MODE
    value: "false"
    required: true
  - description: Volume space available for data, e.g. 512Mi, 2Gi.
    displayName: Volume Capacity
    name: VOLUME_CAPACITY
    required: true
    value: 5Gi
  - name: MEMORY_REQUEST
    description: Memory initially requested by the app container
    displayName: App container requested memory
    required: true
  - name: MEMORY_LIMIT
    description: Maximum memory allocated to the app container
    displayName: App container maximum memory
    required: true
  - displayName: Custom https Route Hostname
    description: 'Custom hostname for https service route. Leave blank for default hostname,
      e.g.: <application-name>.<project>.<default-domain-suffix>'
    name: HOSTNAME_HTTPS
    value: ''
    required: false
objects:
  -
    apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      labels:
        app: ${APPLICATION_NAME}-callback-queue
      name: ${APPLICATION_NAME}-callback-queue
    spec:
      selector:
        app: ${APPLICATION_NAME}-callback-queue
        deploymentconfig: ${APPLICATION_NAME}-callback-queue
      triggers:
        - imageChangeParams:
            automatic: true
            containerNames:
              - ${APPLICATION_NAME}-callback-queue
            from:
              kind: ImageStreamTag
              name: "${APPLICATION_NAME}:${IMAGE_TAG}"
          type: ImageChange
        - type: ConfigChange
      replicas: 1
      template:
        metadata:
          labels:
            app: ${APPLICATION_NAME}-callback-queue
            deploymentconfig: ${APPLICATION_NAME}-callback-queue
        spec:
          containers:
            - env:
              - name: APPLICATION_ENV
                value: ${APPLICATION_ENV}
              - name: APP_DEBUG
                value: ${DEBUG_MODE}
              - name: VERIFYPEER
                value: ${VERIFYPEER}
              - name: POSTGRES_DB_HOST
                value: ${POSTGRES_DB_HOST}
              - name: POSTGRES_DB_PORT
                value: "5432"
              - name: POSTGRES_DB_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: ${POSTGRES_SECRET_NAME}
                    key: username
              - name: POSTGRES_DB_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: ${POSTGRES_SECRET_NAME}
                    key: password
              - name: POSTGRES_DEPLOY_DB_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: ${POSTGRES_ADMIN_SECRET_NAME}
                    key: username
              - name: POSTGRES_DEPLOY_DB_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: ${POSTGRES_ADMIN_SECRET_NAME}
                    key: password
              - name: POSTGRES_PAYMENT_DB_DATABASE
                value: ${POSTGRES_PAYMENT_DB_DATABASE}
              - name: PAYMENT_SERVICE_DOMAIN
                value: ${PAYMENT_SERVICE_DOMAIN}
              - name: TLSCONTACT_API
                value: ${TLSCONTACT_API}
              - name: PGPASSFILE
                value: /opt/app-root/pgpass/.pgpass
              - name: APP_ENV
                value: ${APP_ENV}
              - name: PROJECT
                value: ${NAMESPACE}
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: ${AWS_ACCOUNT_S3}
                    key: AWS_ACCESS_KEY_ID
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: ${AWS_ACCOUNT_S3}
                    key: AWS_SECRET_ACCESS_KEY
              - name: AWS_DEFAULT_REGION
                valueFrom:
                  secretKeyRef:
                    name: ${AWS_ACCOUNT_S3}
                    key: AWS_REGION
              - name: AWS_BUCKET
                valueFrom:
                  secretKeyRef:
                    name: ${AWS_ACCOUNT_S3}
                    key: AWS_BUCKET_NAME
              - name: LOG_CHANNEL
                value: "stdout"
              - name: ELASTIC_APM_SERVICE_NAME
                value: "${OPENSHIFT_ENV}-${PROJECT}-${APPLICATION_NAME}"
              - name: ELASTIC_APM_SECRET_TOKEN
                valueFrom:
                  secretKeyRef:
                    key: ELASTIC_APM_SECRET_TOKEN
                    name: elastic-apm
              - name: ELASTIC_APM_SERVER_URL
                valueFrom:
                  secretKeyRef:
                    key: ELASTIC_APM_SERVER_URLS
                    name: elastic-apm
              - name: ELASTIC_APM_VERIFY_SERVER_CERT
                value: 'false'
              - name: ENVPAY_GLO_COMMON_SANDBOX_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: merchant_id
              - name: ENVPAY_GLO_COMMON_SANDBOX_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: secret
              - name: ENVPAY_GLO_COMMON_SANDBOX_ACCOUNT
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: account
              - name: ENVPAY_GLO_COMMON_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: merchant_id
              - name: ENVPAY_GLO_COMMON_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: secret
              - name: ENVPAY_GLO_BEgbALL2be_ACCOUNT
                valueFrom:
                  secretKeyRef:
                    name: envpay-glo
                      key: account
              - name: ENVPAY_CMI_BEmaAll2be_SANDBOX_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-cmi
                      key: merchant_id
              - name: ENVPAY_CMI_BEmaAll2be_SANDBOX_STOREKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-cmi
                      key: storekey
              - name: ENVPAY_CMI_BEmaAll2be_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-cmi
                      key: merchant_id
              - name: ENVPAY_CMI_BEmaAll2be_STOREKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-cmi
                      key: storekey
              - name: PAYGATE_ZAALL2BE_ENCRYPTION_SANDBOX_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-paygate
                      key: key
              - name: PAYGATE_ZAALL2BE_SANDBOX_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-paygate
                      key: id
              - name: PAYGATE_ZAALL2BE_SELLER_EMAIL
                valueFrom:
                  secretKeyRef:
                    name: envpay-paygate
                      key: email
              - name: PAYGATE_ZAALL2BE_ENCRYPTION_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-paygate
                      key: key
              - name: PAYGATE_ZAALL2BE_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-paygate
                      key: id
              - name: ENVPAY_TINGG_COMMON_SANDBOX_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_COMMON_SANDBOX_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_COMMON_SANDBOX_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_COMMON_SANDBOX_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_COMMON_SANDBOX_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BEcmYAO2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BEcmYAO2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BEcmYAO2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BEcmYAO2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BEcmYAO2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BEcmDLA2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BEcmDLA2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BEcmDLA2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BEcmDLA2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BEcmDLA2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BEsnDKR2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BEsnDKR2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BEsnDKR2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BEsnDKR2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BEsnDKR2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BEetADD2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BEetADD2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BEetADD2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BEetADD2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BEetADD2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BErwKGL2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BErwKGL2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BErwKGL2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BErwKGL2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BErwKGL2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: ENVPAY_TINGG_BEugKLA2be_ACCOUNT_NUMBER
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: account
              - name: ENVPAY_TINGG_BEugKLA2be_SERVICE_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: service_code
              - name: ENVPAY_TINGG_BEugKLA2be_IVKEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: ivkey
              - name: ENVPAY_TINGG_BEugKLA2be_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: secret_key
              - name: ENVPAY_TINGG_BEugKLA2be_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-tingg
                      key: access_key
              - name: FAW_COMMON_SANDBOX_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-faw
                      key: merchant_id
              - name: FAW_COMMON_SANDBOX_SECRET_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-faw
                      key: secret_key
              - name: FAW_egAll2be_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-faw
                      key: merchant_id
              - name: FAW_egAll2be_SECURITY_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-faw
                      key: secret_key
              - name: ENVPAY_PAY_COMMON_SANDBOX_ACCOUNT
                valueFrom:
                  secretKeyRef:
                    name: envpay-paypal
                      key: account
              - name: ENVPAY_PAY_BEruMOW2be_ACCOUNT
                valueFrom:
                  secretKeyRef:
                    name: envpay-paypal
                      key: account
              - name: PAYU_NGALL2BE_SANDBOX_APP_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: ngall2be_app_id
              - name: PAYU_NGALL2BE_SANDBOX_PRIVATE_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: ngall2be_private_key
              - name: PAYU_KEALL2BE_SANDBOX_APP_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: keall2be_app_id
              - name: PAYU_KEALL2BE_SANDBOX_PRIVATE_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: keall2be_private_key
              - name: PAYU_NGALL2BE_APP_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: ngall2be_app_id
              - name: PAYU_NGALL2BE_PRIVATE_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: ngall2be_private_key
              - name: PAYU_KEALL2BE_APP_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: keall2be_app_id
              - name: PAYU_KEALL2BE_PRIVATE_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-payu
                      key: keall2be_private_key
              - name: BANK_PAYMENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envpay-bank
                      key: password
              - name: KBANK_THBKK2BE_SANDBOX_API_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: api_key
              - name: KBANK_THBKK2BE_SANDBOX_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: secret
              - name: KBANK_THBKK2BE_SANDBOX_MID
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: mid
              - name: KBANK_THBKK2BE_API_KEY
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: api_key
              - name: KBANK_THBKK2BE_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: secret
              - name: KBANK_THBKK2BE_MID
                valueFrom:
                  secretKeyRef:
                    name: envpay-kbank
                      key: mid
              - name: SANDBOX_PAYFORT_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: merchant_id
              - name: SANDBOX_PAYFORT_ACCESS_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: access_code
              - name: SANDBOX_PAYFORT_REQUEST_PHRASE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: request_phrase
              - name: SANDBOX_PAYFORT_RESPONSE_PHRASE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: response_phrase
              - name: PAYFORT_MERCHANT_ID
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: merchant_id
              - name: PAYFORT_ACCESS_CODE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: access_code
              - name: PAYFORT_REQUEST_PHRASE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: request_phrase
              - name: PAYFORT_RESPONSE_PHRASE
                valueFrom:
                  secretKeyRef:
                    name: envpay-payfort
                      key: response_phrase
              image: ' '
              imagePullPolicy: Always
              name: ${APPLICATION_NAME}
              ports:
                - containerPort: 8443
                  protocol: TCP
                  name: https
              resources:
                requests:
                  memory: ${MEMORY_REQUEST}
                limits:
                  memory: ${MEMORY_LIMIT}
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
              args:
                  cd /opt/app-root/src/;
                  php artisan queue:work tlscontact_fawry_payment_queue --tries=3 --timeout=60
              volumeMounts:
                - mountPath: /opt/app-root/src/httpd-cfg
                  name: volume-apache-config
                - mountPath: /opt/app-root/src/httpd-ssl/
                  name: volume-ssl
                - mountPath: /opt/app-root/httpd-ssl
                  name: volume-ssl-move
                - mountPath: /opt/app-root/pgpass
                  name: volume-pgpass
                - mountPath: /opt/app-root/src/log
                  name: volume-logs
                - mountPath: /opt/app-root/src/data/
                  name: volume-application-data
          dnsPolicy: ClusterFirst
          restartPolicy: Always
          schedulerName: default-scheduler
          securityContext: {}
          terminationGracePeriodSeconds: 30
          volumes:
            - emptyDir: {}
              name: volume-application-data
            - emptyDir: {}
              name: volume-logs
            - emptyDir: {}
              name: volume-apache-config
            - emptyDir: {}
              name: volume-ssl-move
            - emptyDir: {}
              name: volume-ssl
            - emptyDir: {}
              name: volume-pgpass
            - name: volume-ssl-init
              secret:
                defaultMode: 420
                items:
                  - key: tls.crt
                    path: ./certs/cert.pem
                  - key: tls.key
                    path: ./private/key.pem
                secretName: ${APPLICATION_NAME}-x509-https-secret
  -
    apiVersion: v1
    kind: Service
    metadata:
      annotations:
        service.alpha.openshift.io/serving-cert-secret-name: ${APPLICATION_NAME}-x509-https-secret
      labels:
        app: ${APPLICATION_NAME}
      name: ${APPLICATION_NAME}
    spec:
      selector:
        app: ${APPLICATION_NAME}
      ports:
        - name: https
          port: 8443
  -
    kind: Route
    apiVersion: v1
    id: "${APPLICATION_NAME}-https"
    metadata:
      name: ${APPLICATION_NAME}
      labels:
        app: "${APPLICATION_NAME}"
      annotations:
        description: Route for ${APPLICATION_NAME}'s https service.
        kubernetes.io/tls-acme: 'true'
        haproxy.router.openshift.io/ip_whitelist: ${ROUTE_IP_WHITE_LIST}
        haproxy.router.openshift.io/timeout: "60s"
    spec:
      host: "${HOSTNAME_HTTPS}"
      to:
        name: ${APPLICATION_NAME}
      tls:
        termination: reencrypt
        insecureEdgeTerminationPolicy: Redirect
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-${APPLICATION_NAME}-router
    spec:
      ingress:
        - from:
            - namespaceSelector:
                matchLabels:
                  name: default
          ports:
            - port: 8443
              protocol: TCP
      podSelector:
        matchLabels:
          app: ${APPLICATION_NAME}
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-${APPLICATION_NAME}-pgbouncer
      labels:
        app: ${APPLICATION_NAME}
    spec:
      ingress:
        - from:
            - podSelector:
                matchLabels:
                  app: ${APPLICATION_NAME}
          ports:
            - port: 5432
              protocol: TCP
      podSelector:
        matchLabels:
          crunchy-pgbouncer: 'true'
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-${APPLICATION_NAME}-pgcluster
      labels:
        app: ${APPLICATION_NAME}
    spec:
      ingress:
        - from:
            - podSelector:
                matchLabels:
                  app: ${APPLICATION_NAME}
          ports:
            - port: 5432
              protocol: TCP
      podSelector:
        matchLabels:
          pgo-pg-database: 'true'
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-${APPLICATION_NAME}-service-api
      labels:
        app: ${APPLICATION_NAME}
    spec:
      ingress:
        - from:
            - podSelector:
                matchLabels:
                  app: ${APPLICATION_NAME}
          ports:
            - port: 8443
              protocol: TCP
      podSelector:
        matchLabels:
          app: 'tlsconnect-service-api'
